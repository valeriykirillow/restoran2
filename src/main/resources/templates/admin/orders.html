<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head th:replace="fragments/head :: head"></head>
<body class="container mt-5">

<h1 class="text-center mb-4">Все заказы</h1>

<div class="row">
    <div th:each="order : ${orders}" class="col-md-6">
        <div class="card mb-4 shadow-sm">
            <div class="card-body">
                <h5 class="card-title">Заказ №<span th:text="${order.id}"></span></h5>
                <p><strong>Статус:</strong> <span th:text="${order.status}">Неизвестен</span></p>

                <ul class="list-group mb-3">
                    <li class="list-group-item d-flex justify-content-between align -items-center"
                        th:each="item : ${order.items}">
                        <span th:text="${item.item.name}">Блюдо</span>
                        <span>
                            <span th:text="${item.item.price * item.quantity}">0</span> ₽
                            (<span th:text="${item.quantity}">0</span> шт.)
                        </span>
                    </li>
                </ul>

                <div class="d-flex flex-wrap gap-2">
                    <!-- NEW → Кнопка подтверждения -->
                    <form th:action="@{/admin/confirm/{id}(id=${order.id})}" method="post"
                          th:if="${order.status.name() == 'NEW'}">
                        <button type="submit" class="btn btn-success">Подтвердить и отправить на кухню</button>
                    </form>

                    <!-- IN_PROGRESS → Кнопка выставления счёта -->
                    <form th:action="@{/admin/complete/{id}(id=${order.id})}" method="post"
                          th:if="${order.status.name() == 'IN_PROGRESS'}">
                        <button type="submit" class="btn btn-warning">Выставить счёт</button>
                    </form>

                    <!-- COMPLETED и счёт НЕ оплачен -->
                    <span th:if="${order.invoice != null and order.invoice.status.name() == 'UNPAID'}"
                          class="badge bg-info text-dark mt-2">
                        Счёт выставлен
                    </span>

                    <!-- COMPLETED и счёт ОПЛАЧЕН -->
                    <span th:if="${order.invoice != null and order.invoice.status.name() == 'PAID'}"
                          class="badge bg-success text-light mt-2">
                        ✅ Оплачено
                    </span>
                </div>
            </div>
        </div>
    </div>
</div>
<script>
    // Функция для периодического обновления списка заказов
    setInterval(() => {
        fetch('/admin/orders-status-check')
            .then(response => response.json())
            .then(data => {
                if (data.reload) {
                    location.reload(); // Обновить страницу, если есть изменения
                }
            })
            .catch(error => console.error('Ошибка обновления статусов:', error));
    }, 3000); // Каждые 3 секунды
</script>

</body>
</html>
